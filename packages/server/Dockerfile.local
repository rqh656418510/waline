# https://github.com/nodejs/LTS
FROM node:lts AS build
WORKDIR /app
ENV NODE_ENV production
RUN set -eux; \
        # npm config set registry https://registry.npm.taobao.org; \
        npm config set registry https://mirrors.huaweicloud.com/repository/npm/; \
        npm install --production --silent @waline/vercel

# use local source code
RUN rm -rf /app/node_modules/@waline/vercel/*
COPY ./* /app/node_modules/@waline/vercel/

FROM node:lts-buster-slim
WORKDIR /app
RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
ENV TZ Asia/Shanghai
ENV NODE_ENV production
COPY --from=build /app .
EXPOSE 8360
CMD ["node", "node_modules/@waline/vercel/vanilla.js"]
